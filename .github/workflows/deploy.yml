name: Deploy Config

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Tailscale
      uses: tailscale/github-action@main
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        tags: tag:ci
        args: "--accept-dns=true"

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v4

    - name: Run the Magic Nix Cache
      uses: DeterminateSystems/magic-nix-cache-action@v2

    - name: Check deployment
      run: nix flake check

    - name: Build and deploy
      run: nix run github:serokell/deploy-rs -- --hostname=agamemnon

